#-*- coding: UTF-8 -*-

event_memoryaccess=0
event_probeaccess=6

def doublefetchanalyzer(eventlist):#检查doublefetch漏洞
    userspaceset=set()
    flag=True
    for event in eventlist:
        linenumber,eventnumber,details=event
        if eventnumber != event_memoryaccess:#是否为内存访问类型的事件
            continue
        isuserspaceaddress,addresslist=details
        if not isuserspaceaddress:#检查访问的内存是否位于用户地址空间中
            continue
        for address in addresslist:#对于addresslist中的每个地址，检查是否出现在已访问过的列表中
            if address not in userspaceset:
                userspaceset.add(address)
            else:
                flag=False
                print("[Warning] DoubleFetch found here!")
                print("Line Number =",linenumber)
    if flag:
        print("No DoubleFetch Vulnerability Found")
        
def unprobeanalyzer(eventlist):
    probeaccess=set()
    flag=True
    for event in eventlist:
        linenumber,eventnumber,details=event
        if eventnumber==event_probeaccess:#如果是probeaccess事件
            detail=event[-1]
            for address in range(detail[0],detail[0]+detail[1]):
                probeaccess.add(address)
            continue
        if eventnumber==event_memoryaccess:
            isuserspaceaddress,addresslist=details
            if not isuserspaceaddress:
                continue
            for address in addresslist:
                if address not in probeaccess:
                    print("[Warning] Unprobe found here! Line Number =",linenumber)
                    flag=False
                else:
                    continue
    if flag:
        print("No Unprobe Vulnerablity Found")
                    